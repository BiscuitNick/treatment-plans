'use client'

import { useState } from 'react';
import { TreatmentPlan } from '@/lib/schemas/plan';
import { TherapistView } from './TherapistView';
import { ClientView } from './ClientView';
import { PlanEditor } from './PlanEditor';
import { PlanHistory } from './PlanHistory';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle, Eye, EyeOff, Edit, Clock } from 'lucide-react';
import { SafetyCheckResult, RiskLevel } from '@/services/safety';
import { cn } from '@/lib/utils';
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from '@/components/ui/sheet';

interface DualViewPlanProps {
  plan: TreatmentPlan;
  planId?: string; // Needed for API updates
  safetyResult?: SafetyCheckResult;
  onPlanUpdated?: (newPlan: TreatmentPlan) => void; // Callback to parent to refresh
}

type ViewMode = 'therapist' | 'client';

const AI_DISCLAIMER = "Generated by AI Assistant. This is not a substitute for clinical judgment. Please review carefully.";

export function DualViewPlan({ plan: initialPlan, planId, safetyResult, onPlanUpdated }: DualViewPlanProps) {
  const [plan, setPlan] = useState<TreatmentPlan>(initialPlan);
  const [viewMode, setViewMode] = useState<ViewMode>('therapist');
  const [isEditing, setIsEditing] = useState(false);

  const isHighRisk = safetyResult && safetyResult.riskLevel === RiskLevel.HIGH;

  const handleSave = async (updatedPlan: TreatmentPlan) => {
    if (!planId) {
        // If no ID (e.g. demo mock mode), just update local state
        setPlan(updatedPlan);
        setIsEditing(false);
        return;
    }

    // Call API
    const res = await fetch(`/api/plans/${planId}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedPlan)
    });

    if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update plan");
    }

    // Success
    setPlan(updatedPlan);
    setIsEditing(false);
    if (onPlanUpdated) onPlanUpdated(updatedPlan);
  };

  if (isEditing) {
      return <PlanEditor plan={plan} onSave={handleSave} onCancel={() => setIsEditing(false)} />;
  }

  return (
    <div className="space-y-6">
      {/* Safety Alert Banner */}
      {isHighRisk && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Safety Alert Detected</AlertTitle>
          <AlertDescription>
            {safetyResult.reasoning || "High-risk content was identified during analysis. Please review this plan with extreme caution."}
          </AlertDescription>
        </Alert>
      )}

      {/* Toolbar */}
      <div className="flex justify-between items-center">
          <div className="flex space-x-2">
            <Button variant="outline" size="sm" onClick={() => setIsEditing(true)}>
                <Edit className="h-4 w-4 mr-2" /> Edit Plan
            </Button>
            
            {planId && (
                <Sheet>
                    <SheetTrigger asChild>
                        <Button variant="outline" size="sm">
                            <Clock className="h-4 w-4 mr-2" /> History
                        </Button>
                    </SheetTrigger>
                    <SheetContent>
                        <SheetHeader>
                            <SheetTitle>Version History</SheetTitle>
                        </SheetHeader>
                        <div className="mt-4">
                            <PlanHistory planId={planId} />
                        </div>
                    </SheetContent>
                </Sheet>
            )}
          </div>

          <div className="flex space-x-2">
            <Button
            variant={viewMode === 'therapist' ? 'default' : 'outline'}
            onClick={() => setViewMode('therapist')}
            size="sm"
            className={cn(viewMode === 'therapist' && "pointer-events-none")}
            >
            <Eye className="h-4 w-4 mr-2" /> Therapist View
            </Button>
            <Button
            variant={viewMode === 'client' ? 'default' : 'outline'}
            onClick={() => setViewMode('client')}
            size="sm"
            className={cn(viewMode === 'client' && "pointer-events-none")}
            >
            <EyeOff className="h-4 w-4 mr-2" /> Client View
            </Button>
          </div>
      </div>

      {/* Plan Content */}
      {viewMode === 'therapist' ? (
        <TherapistView plan={plan} />
      ) : (
        <ClientView plan={plan} />
      )}

      {/* AI Disclaimer Footer */}
      <div className="mt-8 p-4 text-sm text-center text-muted-foreground bg-accent/20 rounded-md border">
        {AI_DISCLAIMER}
      </div>
    </div>
  );
}
